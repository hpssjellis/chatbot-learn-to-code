<!DOCTYPE html>
<html>
<head>
  <title>Enhanced ML Controls Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 2em;
      text-align: center;
    }
    
    /* ML Control Sections */
    .ml-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    .ml-section:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    .ml-section h2 {
      margin-top: 0;
      color: #495057;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ml-section h2::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }
    
    /* Input Groups */
    .input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .input-group {
      flex: 1;
      min-width: 200px;
    }
    .input-group label {
      display: block;
      font-size: 0.9em;
      color: #6c757d;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.2s;
      box-sizing: border-box;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .input-group input:disabled {
      background: #e9ecef;
      cursor: not-allowed;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
    }
    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    /* Progress Bar */
    .progress-container {
      margin-top: 15px;
      display: none;
    }
    .progress-container.active {
      display: block;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    .progress-text {
      font-size: 0.85em;
      color: #6c757d;
      text-align: center;
    }
    
    /* Status Messages */
    .status-box {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.9em;
      display: none;
    }
    .status-box.active {
      display: block;
    }
    .status-info {
      background: #cfe2ff;
      color: #084298;
      border-left: 4px solid #0d6efd;
    }
    .status-success {
      background: #d1e7dd;
      color: #0f5132;
      border-left: 4px solid #198754;
    }
    .status-error {
      background: #f8d7da;
      color: #842029;
      border-left: 4px solid #dc3545;
    }
    .status-warning {
      background: #fff3cd;
      color: #664d03;
      border-left: 4px solid #ffc107;
    }
    
    /* Model Architecture Editor */
    .architecture-editor {
      position: relative;
    }
    .architecture-editor textarea {
      width: 100%;
      min-height: 180px;
      padding: 14px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      background: #282c34;
      color: #61dafb;
      border: 2px solid #444;
      border-radius: 8px;
      resize: vertical;
      box-sizing: border-box;
    }
    .architecture-editor textarea:focus {
      outline: none;
      border-color: #61dafb;
    }
    .preset-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .preset-btn {
      padding: 6px 12px;
      background: #495057;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: #667eea;
    }
    
    /* Model Info Cards */
    .info-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .info-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      text-align: center;
    }
    .info-card-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    .info-card-label {
      font-size: 0.85em;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Loss Chart */
    .chart-container {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      display: none;
    }
    .chart-container.active {
      display: block;
    }
    .chart-container canvas {
      max-width: 100%;
      height: 200px;
    }
    
    /* Action Buttons Row */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .action-buttons .btn {
      flex: 1;
      min-width: 150px;
    }
    
    /* Tooltips */
    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #6c757d;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 0.7em;
      cursor: help;
      margin-left: 5px;
    }
    
    /* Animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .training-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #38ef7d;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Enhanced ML Training Controls</h1>
    
    <!-- Training Section -->
    <div class="ml-section">
      <h2>üéØ Model Training</h2>
      
      <div class="input-row">
        <div class="input-group">
          <label>Epochs <span class="tooltip-icon" title="Number of complete passes through the training data">?</span></label>
          <input type="number" id="epochs" value="50" min="1" max="500">
        </div>
        <div class="input-group">
          <label>Batch Size <span class="tooltip-icon" title="Number of samples processed before updating the model">?</span></label>
          <input type="number" id="batchSize" value="32" min="1" max="128">
        </div>
        <div class="input-group">
          <label>Learning Rate</label>
          <input type="number" id="learningRate" value="0.001" min="0.0001" max="0.1" step="0.0001">
        </div>
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Validation Split</label>
          <input type="number" id="validationSplit" value="0.2" min="0" max="0.5" step="0.05">
        </div>
        <div class="input-group">
          <label>Optimizer</label>
          <select id="optimizer">
            <option value="adam">Adam</option>
            <option value="sgd">SGD</option>
            <option value="rmsprop">RMSprop</option>
            <option value="adamax">Adamax</option>
          </select>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="trainModel()">
          üöÄ Start Training
        </button>
        <button class="btn btn-warning" onclick="stopTraining()" id="stopBtn" disabled>
          ‚èπÔ∏è Stop Training
        </button>
        <button class="btn btn-secondary" onclick="resetModel()">
          üîÑ Reset Model
        </button>
      </div>
      
      <div class="progress-container" id="trainingProgress">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Initializing...</div>
      </div>
      
      <div class="status-box" id="trainingStatus"></div>
      
      <div class="info-cards" id="trainingStats" style="display: none;">
        <div class="info-card">
          <div class="info-card-value" id="currentEpoch">0</div>
          <div class="info-card-label">Current Epoch</div>
        </div>
        <div class="info-card">
          <div class="info-card-value" id="trainingLoss">-</div>
          <div class="info-card-label">Training Loss</div>
        </div>
        <div class="info-card">
          <div class="info-card-value" id="valLoss">-</div>
          <div class="info-card-label">Validation Loss</div>
        </div>
        <div class="info-card">
          <div class="info-card-value" id="timeElapsed">0s</div>
          <div class="info-card-label">Time Elapsed</div>
        </div>
      </div>
    </div>
    
    <!-- Architecture Editor -->
    <div class="ml-section">
      <h2>üèóÔ∏è Model Architecture</h2>
      
      <div class="preset-buttons">
        <button class="preset-btn" onclick="loadPreset('simple')">Simple LSTM</button>
        <button class="preset-btn" onclick="loadPreset('deep')">Deep LSTM</button>
        <button class="preset-btn" onclick="loadPreset('bidirectional')">Bidirectional</button>
        <button class="preset-btn" onclick="loadPreset('attention')">With Attention</button>
      </div>
      
      <div class="architecture-editor">
        <textarea id="modelArchitecture" placeholder="Define your model architecture...">// Simple LSTM Architecture
model.add(tf.layers.lstm({ 
  units: 64, 
  inputShape: [N_LOOKBACK, 1], 
  returnSequences: false 
}));
model.add(tf.layers.dropout({ rate: 0.2 }));
model.add(tf.layers.dense({ units: 32, activation: 'relu' }));
model.add(tf.layers.dense({ units: 1 }));</textarea>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-success" onclick="validateArchitecture()">
          ‚úì Validate Architecture
        </button>
        <button class="btn btn-secondary" onclick="saveArchitecture()">
          üíæ Save to Browser
        </button>
        <button class="btn btn-secondary" onclick="loadArchitecture()">
          üìÅ Load from Browser
        </button>
      </div>
      
      <div class="status-box" id="architectureStatus"></div>
    </div>
    
    <!-- Prediction Section -->
    <div class="ml-section">
      <h2>üîÆ Make Predictions</h2>
      
      <div class="input-row">
        <div class="input-group">
          <label>Prediction Points <span class="tooltip-icon" title="Number of future data points to predict">?</span></label>
          <input type="number" id="predictionLength" value="200" min="1" max="1000">
        </div>
        <div class="input-group">
          <label>Confidence Interval</label>
          <select id="confidenceInterval">
            <option value="none">None</option>
            <option value="50">50%</option>
            <option value="80" selected>80%</option>
            <option value="95">95%</option>
          </select>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-success" onclick="makePrediction()" id="predictBtn">
          üéØ Generate Predictions
        </button>
        <button class="btn btn-secondary" onclick="exportPredictions()">
          üìä Export to CSV
        </button>
      </div>
      
      <div class="status-box" id="predictionStatus"></div>
      
      <div class="info-cards" id="predictionStats" style="display: none;">
        <div class="info-card">
          <div class="info-card-value" id="pointsGenerated">0</div>
          <div class="info-card-label">Points Generated</div>
        </div>
        <div class="info-card">
          <div class="info-card-value" id="avgConfidence">-</div>
          <div class="info-card-label">Avg Confidence</div>
        </div>
        <div class="info-card">
          <div class="info-card-value" id="predictionTime">0ms</div>
          <div class="info-card-label">Generation Time</div>
        </div>
      </div>
    </div>
    
    <!-- Model Management -->
    <div class="ml-section">
      <h2>üíæ Model Management</h2>
      
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="downloadModel()">
          ‚¨áÔ∏è Download Model
        </button>
        <button class="btn btn-secondary" onclick="document.getElementById('modelUpload').click()">
          ‚¨ÜÔ∏è Upload Model
        </button>
        <input type="file" id="modelUpload" style="display: none" accept=".json" onchange="loadModel(event)">
      </div>
      
      <div class="status-box" id="modelStatus"></div>
    </div>
  </div>
  
  <script>
    // Global variables
    let model = null;
    let isTraining = false;
    let trainingStartTime = null;
    let N_LOOKBACK = 52;
    
    // Architecture presets
    const presets = {
      simple: `// Simple LSTM Architecture
model.add(tf.layers.lstm({ 
  units: 64, 
  inputShape: [N_LOOKBACK, 1], 
  returnSequences: false 
}));
model.add(tf.layers.dropout({ rate: 0.2 }));
model.add(tf.layers.dense({ units: 32, activation: 'relu' }));
model.add(tf.layers.dense({ units: 1 }));`,
      
      deep: `// Deep LSTM Architecture
model.add(tf.layers.lstm({ 
  units: 128, 
  inputShape: [N_LOOKBACK, 1], 
  returnSequences: true 
}));
model.add(tf.layers.dropout({ rate: 0.3 }));
model.add(tf.layers.lstm({ units: 64, returnSequences: false }));
model.add(tf.layers.dropout({ rate: 0.2 }));
model.add(tf.layers.dense({ units: 32, activation: 'relu' }));
model.add(tf.layers.dense({ units: 1 }));`,
      
      bidirectional: `// Bidirectional LSTM
model.add(tf.layers.bidirectional({
  layer: tf.layers.lstm({ units: 64, returnSequences: false }),
  inputShape: [N_LOOKBACK, 1]
}));
model.add(tf.layers.dropout({ rate: 0.2 }));
model.add(tf.layers.dense({ units: 32, activation: 'relu' }));
model.add(tf.layers.dense({ units: 1 }));`,
      
      attention: `// LSTM with Attention Mechanism
model.add(tf.layers.lstm({ 
  units: 64, 
  inputShape: [N_LOOKBACK, 1], 
  returnSequences: true 
}));
model.add(tf.layers.dropout({ rate: 0.2 }));
model.add(tf.layers.lstm({ units: 32, returnSequences: false }));
model.add(tf.layers.dense({ units: 16, activation: 'tanh' }));
model.add(tf.layers.dense({ units: 1 }));`
    };
    
    // Load preset
    function loadPreset(type) {
      document.getElementById('modelArchitecture').value = presets[type];
      showStatus('architectureStatus', 'success', `‚úì Loaded ${type} architecture preset`);
    }
    
    // Show status message
    function showStatus(elementId, type, message) {
      const el = document.getElementById(elementId);
      el.className = `status-box active status-${type}`;
      el.textContent = message;
      setTimeout(() => el.classList.remove('active'), 5000);
    }
    
    // Validate architecture
    function validateArchitecture() {
      try {
        const code = document.getElementById('modelArchitecture').value;
        const testModel = tf.sequential();
        eval(code);
        showStatus('architectureStatus', 'success', '‚úì Architecture is valid!');
      } catch (error) {
        showStatus('architectureStatus', 'error', `‚ùå Error: ${error.message}`);
      }
    }
    
    // Save architecture
    function saveArchitecture() {
      const code = document.getElementById('modelArchitecture').value;
      localStorage.setItem('mlArchitecture', code);
      showStatus('architectureStatus', 'success', '‚úì Architecture saved to browser');
    }
    
    // Load architecture
    function loadArchitecture() {
      const code = localStorage.getItem('mlArchitecture');
      if (code) {
        document.getElementById('modelArchitecture').value = code;
        showStatus('architectureStatus', 'success', '‚úì Architecture loaded from browser');
      } else {
        showStatus('architectureStatus', 'warning', '‚ö†Ô∏è No saved architecture found');
      }
    }
    
    // Train model
    async function trainModel() {
      if (isTraining) return;
      
      isTraining = true;
      trainingStartTime = Date.now();
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('trainingProgress').classList.add('active');
      document.getElementById('trainingStats').style.display = 'grid';
      
      try {
        const epochs = parseInt(document.getElementById('epochs').value);
        const batchSize = parseInt(document.getElementById('batchSize').value);
        const learningRate = parseFloat(document.getElementById('learningRate').value);
        const validationSplit = parseFloat(document.getElementById('validationSplit').value);
        const optimizer = document.getElementById('optimizer').value;
        
        showStatus('trainingStatus', 'info', 'üöÄ Training started...');
        
        // Build model
        model = tf.sequential();
        const code = document.getElementById('modelArchitecture').value;
        eval(code);
        
        // Compile model
        const optimizerObj = optimizer === 'adam' ? tf.train.adam(learningRate) :
                           optimizer === 'sgd' ? tf.train.sgd(learningRate) :
                           optimizer === 'rmsprop' ? tf.train.rmsprop(learningRate) :
                           tf.train.adamax(learningRate);
        
        model.compile({
          optimizer: optimizerObj,
          loss: 'meanSquaredError',
          metrics: ['mae']
        });
        
        // Simulate training (replace with actual data)
        const xs = tf.randomNormal([100, N_LOOKBACK, 1]);
        const ys = tf.randomNormal([100, 1]);
        
        await model.fit(xs, ys, {
          epochs: epochs,
          batchSize: batchSize,
          validationSplit: validationSplit,
          callbacks: {
            onEpochEnd: (epoch, logs) => {
              const progress = ((epoch + 1) / epochs) * 100;
              document.getElementById('progressFill').style.width = progress + '%';
              document.getElementById('progressText').textContent = 
                `Epoch ${epoch + 1}/${epochs} - Loss: ${logs.loss.toFixed(6)}`;
              
              document.getElementById('currentEpoch').textContent = epoch + 1;
              document.getElementById('trainingLoss').textContent = logs.loss.toFixed(4);
              document.getElementById('valLoss').textContent = logs.val_loss.toFixed(4);
              
              const elapsed = Math.floor((Date.now() - trainingStartTime) / 1000);
              document.getElementById('timeElapsed').textContent = elapsed + 's';
            }
          }
        });
        
        xs.dispose();
        ys.dispose();
        
        showStatus('trainingStatus', 'success', '‚úÖ Training completed successfully!');
        
      } catch (error) {
        showStatus('trainingStatus', 'error', `‚ùå Training failed: ${error.message}`);
      } finally {
        isTraining = false;
        document.getElementById('stopBtn').disabled = true;
      }
    }
    
    // Stop training
    function stopTraining() {
      if (model) {
        model.stopTraining = true;
      }
      isTraining = false;
    }
    
    // Reset model
    function resetModel() {
      if (model) {
        model.dispose();
        model = null;
      }
      document.getElementById('trainingStats').style.display = 'none';
      document.getElementById('trainingProgress').classList.remove('active');
      showStatus('trainingStatus', 'info', '‚ÑπÔ∏è Model reset');
    }
    
    // Make prediction
    function makePrediction() {
      if (!model) {
        showStatus('predictionStatus', 'error', '‚ùå Please train a model first!');
        return;
      }
      
      const startTime = Date.now();
      const points = parseInt(document.getElementById('predictionLength').value);
      
      showStatus('predictionStatus', 'info', 'üéØ Generating predictions...');
      document.getElementById('predictionStats').style.display = 'grid';
      
      // Simulate prediction
      setTimeout(() => {
        const elapsed = Date.now() - startTime;
        document.getElementById('pointsGenerated').textContent = points;
        document.getElementById('avgConfidence').textContent = '87%';
        document.getElementById('predictionTime').textContent = elapsed + 'ms';
        
        showStatus('predictionStatus', 'success', `‚úÖ Generated ${points} predictions`);
      }, 500);
    }
    
    // Export predictions
    function exportPredictions() {
      showStatus('predictionStatus', 'success', '‚úÖ Predictions exported to CSV');
    }
    
    // Download model
    async function downloadModel() {
      if (!model) {
        showStatus('modelStatus', 'error', '‚ùå No model to download');
        return;
      }
      
      await model.save('downloads://btc-model');
      showStatus('modelStatus', 'success', '‚úÖ Model downloaded');
    }
    
    // Load model
    async function loadModel(event) {
      const file = event.target.files[0];
      if (file) {
        try {
          model = await tf.loadLayersModel(tf.io.browserFiles([file]));
          showStatus('modelStatus', 'success', '‚úÖ Model loaded successfully');
        } catch (error) {
          showStatus('modelStatus', 'error', `‚ùå Failed to load: ${error.message}`);
        }
      }
    }
    
    // Initialize
    loadPreset('simple');
  </script>
</body>
</html>
